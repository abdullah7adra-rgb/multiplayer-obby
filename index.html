<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Obby</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial; }
        #login-ui {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 20px; border-radius: 10px; text-align: center;
        }
        input { padding: 10px; width: 200px; border-radius: 5px; border: none; }
        button { padding: 10px 20px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px; }
        #error-msg { color: #ff4444; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div id="login-ui">
        <h2>Enter Username</h2>
        <input type="text" id="username-input" placeholder="3-20 characters" maxlength="20">
        <button id="start-btn">Join Game</button>
        <div id="error-msg"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const socket = io();
        const loginUI = document.getElementById('login-ui');
        const usernameInput = document.getElementById('username-input');
        const startBtn = document.getElementById('start-btn');
        const errorMsg = document.getElementById('error-msg');

        let myId;
        let players = {};
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        startBtn.onclick = () => {
            const name = usernameInput.value.trim();
            if (name.length < 3 || name.length > 20) {
                errorMsg.innerText = "Name must be 3-20 letters.";
                return;
            }
            socket.emit('checkUsername', name);
        };

        socket.on('usernameResult', (data) => {
            if (data.success) {
                loginUI.style.display = 'none';
                initGame(data.name);
            } else {
                errorMsg.innerText = "Username already taken!";
            }
        });

        function createNameTag(name) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 64;
            ctx.fillStyle = 'white';
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(name, 128, 45);
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(2, 0.5, 1);
            sprite.position.y = 1.5;
            return sprite;
        }

        function initGame(username) {
            const geo = new THREE.BoxGeometry();
            const mat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.add(createNameTag(username));
            scene.add(mesh);
            
            camera.position.z = 5;
            
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
            
            socket.emit('join', { name: username });
        }

        socket.on('currentPlayers', (serverPlayers) => {
            Object.keys(serverPlayers).forEach(id => {
                if (!players[id] && id !== socket.id) {
                    const pGeo = new THREE.BoxGeometry();
                    const pMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    const pMesh = new THREE.Mesh(pGeo, pMat);
                    pMesh.add(createNameTag(serverPlayers[id].name));
                    scene.add(pMesh);
                    players[id] = pMesh;
                }
            });
        });
    </script>
</body>
</html>
